language: php
php: 7
before_install:
  - sudo apt-get -qq update
  - sudo apt-get install php-pear
#  - pecl list
  - pecl channel-update pecl.php.net
  - pecl install mongodb
  - cp /tmp/pear/install/pear-build-travisuhWaKN/install-mongodb-1.1.8/home/travis/.phpenv/versions/7.0.10/lib/php/extensions/no-debug-zts-20151012/mongodb.so /usr/lib/php/20151012/mongodb.so
#  - php7 -m
#  - php --version
  - sudo apt-get install software-properties-common
  - echo "\n" | sudo add-apt-repository ppa:ondrej/php
  - sudo apt-get update
  - sudo apt-get install php7.0-fpm php7.0-curl php7.0-cli php7.0-mbstring apache2-utils git php7.0-dev build-essential php7.0-pgsql php7.0-json php7.0-gd php7.0-odbc
  - sudo apt-get install -y --force-yes mongodb-org
  - sudo service php7.0-fpm restart
#  - ls -al /var/run/
#  - ls -al /var/run/php/
#  - cat /etc/php/7.0/fpm/pool.d/www.conf | grep listen
  - ls -al /usr/lib/php/20151012

# mongodb extension
#  - apt-get install libssl-dev libcurl4-openssl-dev
#  - printf "\n" | pecl install mongodb
#  - sudo less /etc/php/7.0/fpm/php.ini
  - echo "extension=mongodb.so" | sudo tee --append /etc/php/7.0/fpm/php.ini > /dev/null
  - cat /etc/php/7.0/fpm/php.ini
  - sudo apt-get install nginx
  - sudo mkdir -p /usr/share/nginx/webcontent
  - sudo chmod 777 /usr/share/nginx/webcontent
#  - sudo cat /etc/nginx/nginx.conf
  - sudo cp nginx.conf /etc/nginx/nginx.conf
  - sudo service nginx restart
  - sudo aptitude install apache2-utils
  - sudo cp test.php /usr/share/nginx/webcontent/test.php
  - sudo cp composer.* /usr/share/nginx/webcontent/
  - cat /var/log/nginx/error.log
  - sudo service php7.0-fpm restart
  - mongod --version
before_script:
  - cd /usr/share/nginx/webcontent/
  - ls -al
  - composer install
  - ls -al
  - pecl list
  - php-fpm7.0 -i

script:
  - php /usr/share/nginx/webcontent/test.php
#  - ab -c 40 -n 1000 http://localhost/test.php
  - wget http://localhost/test.php
  - cat /var/log/nginx/error.log
  - cat /var/log/nginx/access.log
  - cat /tmp/mongodb-errors.log

notifications:
  email:
    on_success: never
    on_failure: always